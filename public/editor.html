<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/preact@10.19.2",
        "preact/": "https://esm.sh/preact@10.19.2/",
        "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
  <title>Sound Asset Management - Goal 2</title>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto p-8">
    <h1 class="text-4xl font-bold mb-2 text-gray-800">Sound Asset Management</h1>
    <p class="text-gray-600 mb-8">Goal 2: Manage Sound Sources for Ambient Coffee</p>
    
    <!-- Sound Source List -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Sound Sources</h2>
        <button 
          id="add-sound-source-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors"
        >
          Add Sound Source
        </button>
      </div>
      
      <div id="sound-source-list" class="space-y-4">
        <!-- Sound sources will be rendered here -->
      </div>
      
      <div id="empty-state" class="text-center py-12 text-gray-500" style="display: none;">
        <p class="text-lg">No sound sources yet</p>
        <p class="text-sm">Click "Add Sound Source" to get started</p>
      </div>
    </div>

    <!-- Sound Source Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Edit Sound Source</h3>
            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Sound Source Editor Form -->
          <div class="space-y-6">
            <!-- Label Input -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Label</label>
              <input 
                type="text" 
                id="source-label-input" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter sound source label"
              />
            </div>

            <!-- Audio Clips Management -->
            <div>
              <div class="flex justify-between items-center mb-3">
                <label class="block text-sm font-medium text-gray-700">Audio Clips</label>
                <button 
                  id="add-clip-btn"
                  class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-md transition-colors flex items-center gap-2"
                >
                  <box-icon name='upload' color='white' size='16px'></box-icon>
                </button>
              </div>
              <div id="clips-list" class="space-y-2">
                <!-- Clips will be rendered here -->
              </div>
              <div id="no-clips-message" class="text-center py-4 text-gray-500 border-2 border-dashed border-gray-300 rounded-md">
                No audio clips added yet
              </div>
            </div>

            <!-- Repeat Count Range -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Repeat Count Range</label>
              <div id="repeat-count-picker"></div>
            </div>

            <!-- Repeat Delay Range -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Repeat Delay Range (seconds)</label>
              <div id="repeat-delay-picker"></div>
            </div>

            <!-- Attack Range -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Attack Range (seconds)</label>
              <div id="attack-picker"></div>
            </div>

            <!-- Decay Range -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Decay Range (seconds)</label>
              <div id="decay-picker"></div>
            </div>

            <!-- Modal Actions -->
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button 
                id="cancel-btn" 
                class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors"
              >
                Cancel
              </button>
              <button 
                id="save-btn" 
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden file input for audio uploads -->
    <input type="file" id="audio-file-input" accept=".mp3,audio/mpeg" style="display: none;">
  </div>

  <script type="module">
    import { render, createElement } from 'preact';
    import { html } from 'htm/preact';
    import { NumberRangePicker } from './js/common/number-range-picker.js';

    // Application state
    let soundSources = [
      // Example sound source
      {
        id: 'horse-gallop',
        label: 'Horse Gallop',
        clips: ['media/horse-gallop-01.mp3', 'media/horse-gallop-02.mp3'],
        repeatCount: { min: 1, max: 5 },
        repeatDelay: { min: 0, max: 0.5 },
        attack: { min: 0, max: 2 },
        decay: { min: 0, max: 2 }
      }
    ];
    
    let currentEditingId = null;
    let currentSoundSource = null;

    // Wait for all scripts to load and setup globals
    window.addEventListener('load', async () => {

      // Initialize the application
      initializeApp();

      function initializeApp() {
        renderSoundSourceList();
        setupEventListeners();
      }

      function setupEventListeners() {
        // Add sound source button
        document.getElementById('add-sound-source-btn').addEventListener('click', () => {
          openEditor();
        });

        // Modal close buttons
        document.getElementById('close-modal-btn').addEventListener('click', closeEditor);
        document.getElementById('cancel-btn').addEventListener('click', closeEditor);
        
        // Save button
        document.getElementById('save-btn').addEventListener('click', saveSoundSource);

        // Add clip button
        document.getElementById('add-clip-btn').addEventListener('click', addClip);

        // File input change
        document.getElementById('audio-file-input').addEventListener('change', handleFileUpload);

        // Close modal when clicking outside
        document.getElementById('editor-modal').addEventListener('click', (e) => {
          if (e.target.id === 'editor-modal') {
            closeEditor();
          }
        });
      }

      function renderSoundSourceList() {
        const listContainer = document.getElementById('sound-source-list');
        const emptyState = document.getElementById('empty-state');

        if (soundSources.length === 0) {
          listContainer.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';
        listContainer.innerHTML = soundSources.map(source => `
          <div class="border border-gray-200 rounded-md p-4 hover:bg-gray-50 transition-colors">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="text-lg font-medium text-gray-800">${source.label || 'Untitled'}</h3>
                <p class="text-sm text-gray-600 mt-1">
                  ${source.clips.length} clip${source.clips.length !== 1 ? 's' : ''}
                </p>
                <div class="text-xs text-gray-500 mt-2 space-y-1">
                  <div>Repeat: ${source.repeatCount.min}-${source.repeatCount.max}</div>
                  <div>Delay: ${source.repeatDelay.min}s-${source.repeatDelay.max}s</div>
                  <div>Attack: ${source.attack.min}s-${source.attack.max}s</div>
                  <div>Decay: ${source.decay.min}s-${source.decay.max}s</div>
                </div>
              </div>
              <div class="flex space-x-2">
                <button 
                  onclick="editSoundSource('${source.id}')"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors"
                >
                  Edit
                </button>
                <button 
                  onclick="deleteSoundSource('${source.id}')"
                  class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      function openEditor(sourceId = null) {
        currentEditingId = sourceId;
        
        if (sourceId) {
          // Edit existing sound source
          currentSoundSource = { ...soundSources.find(s => s.id === sourceId) };
          document.getElementById('modal-title').textContent = 'Edit Sound Source';
        } else {
          // Create new sound source
          currentSoundSource = {
            id: generateId(),
            label: '',
            clips: [],
            repeatCount: { min: 1, max: 1 },
            repeatDelay: { min: 0, max: 0 },
            attack: { min: 0, max: 0 },
            decay: { min: 0, max: 0 }
          };
          document.getElementById('modal-title').textContent = 'Add Sound Source';
        }

        // Populate form
        document.getElementById('source-label-input').value = currentSoundSource.label;
        
        // Render clips
        renderClipsList();
        
        // Render range pickers
        renderRangePickers();
        
        // Show modal
        document.getElementById('editor-modal').classList.remove('hidden');
        document.getElementById('editor-modal').classList.add('flex');
      }

      function closeEditor() {
        document.getElementById('editor-modal').classList.add('hidden');
        document.getElementById('editor-modal').classList.remove('flex');
        currentEditingId = null;
        currentSoundSource = null;
      }

      function renderClipsList() {
        const clipsList = document.getElementById('clips-list');
        const noClipsMessage = document.getElementById('no-clips-message');

        if (currentSoundSource.clips.length === 0) {
          clipsList.innerHTML = '';
          noClipsMessage.style.display = 'block';
          return;
        }

        noClipsMessage.style.display = 'none';
        clipsList.innerHTML = currentSoundSource.clips.map((clip, index) => `
          <div class="flex items-center justify-between bg-gray-50 p-3 rounded border">
            <span class="text-sm text-gray-700">${clip.split('/').pop()}</span>
            <button 
              onclick="removeClip(${index})"
              class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded transition-colors flex items-center justify-center"
              title="Remove clip"
            >
              <box-icon name='trash' color='white' size='16px'></box-icon>
            </button>
          </div>
        `).join('');
      }

      function renderRangePickers() {
        // Repeat Count Picker
        render(
          html`<${NumberRangePicker}
            minAllowed=${1}
            maxAllowed=${20}
            min=${currentSoundSource.repeatCount.min}
            max=${currentSoundSource.repeatCount.max}
            snap=${1}
            width=${400}
            onChange=${(values) => {
              currentSoundSource.repeatCount = { min: values.min, max: values.max };
            }}
          />`,
          document.getElementById('repeat-count-picker')
        );

        // Repeat Delay Picker
        render(
          html`<${NumberRangePicker}
            minAllowed=${0}
            maxAllowed=${10}
            min=${currentSoundSource.repeatDelay.min}
            max=${currentSoundSource.repeatDelay.max}
            snap=${0.1}
            width=${400}
            onChange=${(values) => {
              currentSoundSource.repeatDelay = { min: values.min, max: values.max };
            }}
          />`,
          document.getElementById('repeat-delay-picker')
        );

        // Attack Picker
        render(
          html`<${NumberRangePicker}
            minAllowed=${0}
            maxAllowed=${10}
            min=${currentSoundSource.attack.min}
            max=${currentSoundSource.attack.max}
            snap=${0.1}
            width=${400}
            onChange=${(values) => {
              currentSoundSource.attack = { min: values.min, max: values.max };
            }}
          />`,
          document.getElementById('attack-picker')
        );

        // Decay Picker
        render(
          html`<${NumberRangePicker}
            minAllowed=${0}
            maxAllowed=${10}
            min=${currentSoundSource.decay.min}
            max=${currentSoundSource.decay.max}
            snap=${0.1}
            width=${400}
            onChange=${(values) => {
              currentSoundSource.decay = { min: values.min, max: values.max };
            }}
          />`,
          document.getElementById('decay-picker')
        );
      }

      function addClip() {
        document.getElementById('audio-file-input').click();
      }

      async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.includes('audio')) {
          alert('Please select an audio file');
          return;
        }

        if (!file.name.toLowerCase().endsWith('.mp3')) {
          alert('Please select an MP3 file');
          return;
        }

        try {
          // Convert file to base64
          const reader = new FileReader();
          reader.onload = async function(e) {
            const base64Data = e.target.result;
            
            const response = await fetch('/upload-audio', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                fileName: file.name,
                fileData: base64Data
              })
            });

            const result = await response.json();

            if (result.success) {
              currentSoundSource.clips.push(result.filePath);
              renderClipsList();
            } else {
              alert('Error uploading file: ' + result.error);
            }
          };
          
          reader.onerror = function() {
            alert('Error reading file');
          };
          
          reader.readAsDataURL(file);
          
        } catch (error) {
          alert('Error uploading file: ' + error.message);
        }

        // Reset file input
        event.target.value = '';
      }

      function saveSoundSource() {
        // Validate
        if (!currentSoundSource.label.trim()) {
          alert('Please enter a label for the sound source');
          return;
        }

        // Update label from input
        currentSoundSource.label = document.getElementById('source-label-input').value.trim();

        if (currentEditingId) {
          // Update existing
          const index = soundSources.findIndex(s => s.id === currentEditingId);
          if (index !== -1) {
            soundSources[index] = { ...currentSoundSource };
          }
        } else {
          // Add new
          soundSources.push({ ...currentSoundSource });
        }

        renderSoundSourceList();
        closeEditor();
      }

      function generateId() {
        return 'source_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      // Global functions for inline event handlers
      window.editSoundSource = (id) => {
        openEditor(id);
      };

      window.deleteSoundSource = (id) => {
        if (confirm('Are you sure you want to delete this sound source?')) {
          soundSources = soundSources.filter(s => s.id !== id);
          renderSoundSourceList();
        }
      };

      window.removeClip = (index) => {
        currentSoundSource.clips.splice(index, 1);
        renderClipsList();
      };

    });
  </script>
</body>
</html>
